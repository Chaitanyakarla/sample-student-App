# How to Configure a Deployed Stack

## Background
Middleware is designed to mediate between front-end applications _(Android, iOS, website etc)_ and institution back-ends.

This means it needs to be able to receive a request from a front-end application, determine which backend to route that request to and relay the response to the backend.

To do this, it needs a way to associate front-ends with backends, and the data required to communicate with backend servers.

The information required to do this is the Middleware Stack's configuration data.

## Configuration Data Types

1.  **Institution**

    A legal entity that provides education as a service. Think University or College, but isn't limited to those types of organizations.

    Institution data consists of:
    - **Slug**: unique identifier in Middleware's config storage system for an Institution

    **Example**:
    ```js
    {
      "slug": "rnp-college-of-works"
    }
    ```

    **Store Location**:

    `Deployment Stack` -> `Config Manager Stack` -> `S3 Bucket` -> `data/institutions.json`

    **Store Content**:

    ```js
    [
      { "slug": "rnp-college-of-works" },
      { "slug": "rnp-university" }
    ]
    ```

2.  **Salesforce Connected App**

    Salesforce is the primary Inbackend we expect to connect to. Connected Apps is the official way to gain access to a Salesforce instance's API.

    Salesforce Connected App data consists of:
    - **Consumer Key**: generated by Salesforce when the Connected App is created, used to create API Access Tokens
    - **RSA Private Key**: config bucket path to RSA Private Key generated by Connected App owner and used to sign requests sent to a Salesforce instance's API
    - **Slug**: unique identifier in Middleware's config storage system for a Salesforce Connected App

    **Example**:
    ```js
    {
      "slug": "rnpdev",
      "private_key": "salesforce-app-keys/rnpdev.key",
      "consumer_key": "3MVG9Nk1FpUrSQHccu4rAj1Nw6h.ManbDTHJQjdjj13xhvCR58CuG.SCW0fmEV0lpgyFlWGzMqiO_K.CYMZHz"
    }
    ```

    **Store Location**:

    `CloudFormation Stack` -> `Config Manager Stack` -> `S3 Bucket` -> `data/salesforce-connected-apps.json`

    **Store Content**:

    ```js
    [
      {
        "slug": "rnpdev",
        "private_key": "salesforce-app-keys/rnpdev.key",
        "consumer_key": "3MVG9Nk1FpUrSQHccu4rAj1Nw6h.ManbDTHJQjdjj13xhvCR58CuG.SCW0fmEV0lpgyFlWGzMqiO_K.CYMZHz"
      },
      {
        "slug": "rnpprod",
        "private_key": "salesforce-app-keys/rnpprod.key",
        "consumer_key": "js8JsnL1FpUrSQHccu4rAj1Nw6h.ManbDTHJQjdjj13xhvCR58CuG.SCW0fmEV0lpgyFlWGzMqiO_K.nYF38a"
      },
    ]
    ```

3.  **Salesforce Installation**

    A specific Salesforce Org, presumably one that has installed R&P's Managed Package, which contains the custom code that powers our Student App integration.

    Salesforce Installation data consists of:
    - **Institution**: slug of the Institution that owns this Salesforce Org
    - **Connected App**: slug of a Salesforce Connected App installed in this Salesforce Org
    - **Environment**: type of Salesforce Org environment this specific Org is running in
    - **Endpoint**: url required to access this Salesforce Org's API
    - **Username**: unique identifier in Salesforce for a user account
    - **Slug**: unique identifier in Middleware's config storage system for a Salesforce Org

    **Example**:
    ```js
    {
      "slug": "rnp-college-of-works-staging",
      "institution": "rnp-college-of-works",
      "connected_app": "rnpdev",
      "environment": "production",
      "endpoint": "https://studentapp-uat-dev-ed.my.salesforce.com",
      "username": "chris.hatton@studentapp.uat"
    }
    ```

    **Store Location**:

    `CloudFormation Stack` -> `Config Manager Stack` -> `S3 Bucket` -> `data/salesforce-installations.json`

    **Store Content**:
    ```js
    [
      {
        "slug": "rnp-college-of-works-staging",
        "institution": "rnp-college-of-works",
        "connected_app": "rnpdev",
        "environment": "production",
        "endpoint": "https://studentapp-uat-dev-ed.my.salesforce.com",
        "username": "chris.hatton@studentapp.uat"
      },
      {
        "slug": "rnp-college-of-works-production",
        "institution": "rnp-college-of-works",
        "connected_app": "rnpprod",
        "environment": "production",
        "endpoint": "https://studentapp-prod-ed.my.salesforce.com",
        "username": "chris.hatton@studentapp.uat"
      }
    ]
    ```

4.  **Middleware API Key**

    This is an opaque ID given to a front-end app which Middleware maps to a backend type and the requirements necessary to connect to a specific backend instance.

    Middleware API Key data consists of:
    - **API Key**: unique identifier in Middleware system for an Institution's configuration data
    - **Institution**: slug of the Institution that owns this config data
    - **Integration Type**: specifies which type of institution backend this key provides access to
    - **Integration Slug**: unique identifier in Middlewares config store for this Integration's configuration data

    **Example**:
    ```js
    {
      "api_key": "8d79180x-378f-42ae-884e-f2d00ad44f54",
      "institution": "rnp-college-of-works",
      "integration": {
        "type": "salesforce",
        "slug": "rnp-college-of-works-staging"
      }
    }
    ```

    **Store Location**:

    `CloudFormation Stack` -> `Config Manager Stack` -> `S3 Bucket` -> `data/institution-api-keys.json`

    **Store Content**:

    ```js
    [
      {
        "api_key": "8d79180x-378f-42ae-884e-f2d00ad44f54",
        "institution": "rnp-college-of-works",
        "integration": {
          "type": "salesforce",
          "slug": "rnp-college-of-works-staging"
        }
      },
      {
        "api_key": "79180x8d-38f7-a42e-84e8-f0f54ad442d0",
        "institution": "rnp-college-of-works",
        "integration": {
          "type": "salesforce",
          "slug": "rnp-college-of-works-production"
        }
      }
    ]
    ```